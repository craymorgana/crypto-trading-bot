<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Scalping Bot - Trading Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="http://localhost:35729/livereload.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ Crypto Scalping Bot</h1>
            <p>Live Paper Trading Dashboard</p>
            <div class="status">‚óè LIVE MONITORING</div>
        </header>

        <!-- Performance Metrics -->
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-label">Total Balance</div>
                <div class="stat-number" id="currentBalance">$0.00</div>
                <div class="stat-label" style="color: #00ff88; margin-top: 5px;" id="totalReturn">+0.00%</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Total P&L</div>
                <div class="stat-number" id="totalProfitLoss">$0.00</div>
                <div class="stat-label">Win Rate: <span id="winRate">0%</span></div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Trades</div>
                <div class="stat-number" id="totalTrades">0</div>
                <div class="stat-label">Wins: <span id="totalWins">0</span> | Losses: <span id="totalLosses">0</span></div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Open Positions</div>
                <div class="stat-number" id="openPositions">0</div>
                <div class="stat-label" id="lastUpdate">Last update: Never</div>
            </div>
        </div>

        <div class="dashboard-wrapper">
            <!-- LEFT COLUMN -->
            <div class="left-column">
                <!-- Open Positions -->
                <div class="section">
                    <div class="section-title">üìà Open Positions</div>
                    <table id="openPositionsTable">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Signal</th>
                                <th>Entry Price</th>
                                <th>Stop Loss</th>
                                <th>Target</th>
                                <th>Confidence</th>
                                <th>Indicators</th>
                            </tr>
                        </thead>
                        <tbody id="openPositionsBody">
                            <tr><td colspan="7" class="no-data">No open positions</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Recent Closed Trades -->
                <div class="section">
                    <div class="section-title">‚úÖ Recent Closed Trades</div>
                    <table id="closedTradesTable">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Signal</th>
                                <th>Entry Price</th>
                                <th>Exit Price</th>
                                <th>P&L</th>
                                <th>Return %</th>
                                <th>Reason</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="closedTradesBody">
                            <tr><td colspan="8" class="no-data">No closed trades yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div class="right-column">
                <!-- Recent Signals -->
                <div class="section">
                    <div class="section-title">üéØ Recent Signals</div>
                    <table id="signalsTable">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Symbol</th>
                                <th>Signal</th>
                                <th>Confidence</th>
                                <th>Pattern</th>
                                <th>Indicators</th>
                                <th>Fib/Harmonics</th>
                            </tr>
                        </thead>
                        <tbody id="signalsBody">
                            <tr><td colspan="7" class="no-data">No signals yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="refresh-info">
            üì° Dashboard updates every 2 seconds | Data refreshed at: <span id="refreshTime">--:--:--</span>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        const REFRESH_INTERVAL = 2000; // 2 seconds

        // Format currency
        function formatCurrency(num) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(num);
        }

        // Format percentage
        function formatPercent(num) {
            const sign = num >= 0 ? '+' : '';
            return `${sign}${num.toFixed(2)}%`;
        }

        // Format time
        function formatTime(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleTimeString();
        }

        // Update dashboard
        async function updateDashboard() {
            try {
                const response = await fetch(`${API_BASE}/data`);
                const data = await response.json();

                // Update stats
                const stats = data.stats;
                document.getElementById('currentBalance').textContent = formatCurrency(stats.currentBalance);
                document.getElementById('totalReturn').textContent = formatPercent(stats.totalReturn);
                document.getElementById('totalProfitLoss').textContent = formatCurrency(stats.totalProfitLoss);
                document.getElementById('winRate').textContent = stats.winRate + '%';
                document.getElementById('totalTrades').textContent = stats.totalTrades;
                document.getElementById('totalWins').textContent = stats.totalWins;
                document.getElementById('totalLosses').textContent = stats.totalLosses;
                document.getElementById('openPositions').textContent = stats.openPositions;
                document.getElementById('lastUpdate').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
                document.getElementById('refreshTime').textContent = new Date().toLocaleTimeString();

                // Update color based on P&L
                const plElement = document.getElementById('totalProfitLoss');
                plElement.className = stats.totalProfitLoss >= 0 ? 'positive' : 'negative';
                const returnElement = document.getElementById('totalReturn');
                returnElement.className = stats.totalReturn >= 0 ? 'positive' : 'negative';

                // Update open positions
                updateOpenPositions(data.trades);

                // Update closed trades
                updateClosedTrades(data.trades);

                // Update signals
                updateSignals(data.signals);

            } catch (err) {
                console.error('Error updating dashboard:', err);
            }
        }

        function updateOpenPositions(trades) {
            const openTrades = trades.filter(t => t.status === 'OPEN');
            const tbody = document.getElementById('openPositionsBody');

            if (openTrades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">No open positions</td></tr>';
                return;
            }

            tbody.innerHTML = openTrades.map(trade => {
                const indicators = [trade.pattern, trade.indicators].filter(Boolean).join(', ');
                return `
                    <tr>
                        <td>${trade.symbol}</td>
                        <td><span class="badge ${trade.signal === 'BULLISH' ? 'badge-bullish' : 'badge-bearish'}">${trade.signal}</span></td>
                        <td>$${trade.entryPrice.toFixed(2)}</td>
                        <td>$${trade.stopPrice.toFixed(2)}</td>
                        <td>$${trade.targetPrice.toFixed(2)}</td>
                        <td>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${trade.confidence}%">
                                    ${trade.confidence}%
                                </div>
                            </div>
                        </td>
                        <td><span class="indicator">${indicators || 'N/A'}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function updateClosedTrades(trades) {
            const closedTrades = trades
                .filter(t => t.status === 'CLOSED')
                .sort((a, b) => new Date(b.exitTime) - new Date(a.exitTime))
                .slice(0, 15);

            const tbody = document.getElementById('closedTradesBody');

            if (closedTrades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">No closed trades yet</td></tr>';
                return;
            }

            tbody.innerHTML = closedTrades.map(trade => {
                const profitClass = trade.profitLoss >= 0 ? 'positive' : 'negative';
                return `
                    <tr>
                        <td>${trade.symbol}</td>
                        <td><span class="badge ${trade.signal === 'BULLISH' ? 'badge-bullish' : 'badge-bearish'}">${trade.signal}</span></td>
                        <td>$${trade.entryPrice.toFixed(2)}</td>
                        <td>$${trade.exitPrice.toFixed(2)}</td>
                        <td class="${profitClass}">$${trade.profitLoss.toFixed(2)}</td>
                        <td class="${profitClass}">${formatPercent(trade.profitLossPercent)}</td>
                        <td>${trade.reason}</td>
                        <td>${formatTime(trade.exitTime)}</td>
                    </tr>
                `;
            }).join('');
        }

        // Config trading symbols order
        const configSymbols = [
            'BTC-USD', 'ETH-USD', 'XRP-USD', 'ADA-USD',
            'SOL-USD', 'LTC-USD'
        ];

        function updateSignals(signals) {
            const tbody = document.getElementById('signalsBody');
            
            if (signals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">No signals yet</td></tr>';
                return;
            }

            // Group signals by symbol
            const signalsBySymbol = {};
            signals.forEach(signal => {
                if (!signalsBySymbol[signal.symbol]) {
                    signalsBySymbol[signal.symbol] = [];
                }
                signalsBySymbol[signal.symbol].push(signal);
            });

            // Get latest signal for each symbol (sorted by timestamp), ordered by config
            const displaySignals = configSymbols
                .filter(symbol => signalsBySymbol[symbol])
                .map(symbol => {
                    const symbolSignals = signalsBySymbol[symbol]
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    return symbolSignals[0];
                });

            if (displaySignals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">No signals yet</td></tr>';
                return;
            }

            tbody.innerHTML = displaySignals.map(signal => {
                const indicatorsList = [
                    signal.indicators?.signal,
                    signal.fibonacci ? 'Fib' : null,
                    signal.harmonics ? 'Harmonics' : null
                ].filter(Boolean).join(', ');

                return `
                    <tr>
                        <td>${formatTime(signal.timestamp)}</td>
                        <td><strong>${signal.symbol || 'N/A'}</strong></td>
                        <td><span class="badge ${signal.signal === 'BULLISH' ? 'badge-bullish' : signal.signal === 'BEARISH' ? 'badge-bearish' : 'badge-neutral'}">${signal.signal}</span></td>
                        <td>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${signal.confidence}%">
                                    ${signal.confidence}%
                                </div>
                            </div>
                        </td>
                        <td>${signal.pattern || 'N/A'}</td>
                        <td><span class="indicator">${signal.indicators?.signal || 'N/A'}</span></td>
                        <td>${indicatorsList || 'N/A'}</td>
                    </tr>
                `;
            }).join('');
        }

        // Auto-refresh dashboard
        setInterval(updateDashboard, REFRESH_INTERVAL);

        // Initial load
        updateDashboard();
    </script>
</body>
</html>