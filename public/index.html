<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoAI - Premium Trading Terminal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="background-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">ü§ñ</div>
                    <div class="logo-text">
                        <h1>CryptoAI Pro</h1>
                        <span class="subtitle">Combined Scalp + Swing Trading</span>
                    </div>
                </div>
                <div class="status-badge">
                    <span class="status-dot"></span>
                    SYSTEM ONLINE
                </div>
            </div>
        </header>

        <!-- Performance Metrics -->
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-label">Kraken Balance</div>
                <div class="stat-number" id="currentBalance">$0.00</div>
                <div class="stat-label" style="color: #00ff88; margin-top: 5px;" id="totalReturn">+0.00%</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Available (Kraken)</div>
                <div class="stat-number" id="availableBalance">$0.00</div>
                <div class="stat-label">Invested: <span id="investedCapital">$0.00</span></div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Total P&L</div>
                <div class="stat-number" id="totalProfitLoss">$0.00</div>
                <div class="stat-label">Win Rate: <span id="winRate">0%</span></div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Trades</div>
                <div class="stat-number" id="totalTrades">0</div>
                <div class="stat-label">Wins: <span id="totalWins">0</span> | Losses: <span id="totalLosses">0</span>
                </div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Open Positions</div>
                <div class="stat-number" id="openPositions">0</div>
                <div class="stat-label" id="lastUpdate">Last update: Never</div>
            </div>
        </div>

        <!-- Coin Holdings from Kraken (only visible in live mode) -->
        <div class="section coin-holdings-section" id="coinHoldingsSection" style="display:none;">
            <div class="section-title">üí∞ Kraken Coin Holdings <span class="holdings-total" id="holdingsTotalValue">Total: --</span></div>
            <div class="coin-holdings-row" id="coinHoldingsGrid">
                <div class="no-data">Loading balances...</div>
            </div>
        </div>

        <!-- Strategy Performance Cards -->
        <div class="strategy-cards">
            <div class="strategy-card scalper">
                <div class="strategy-header">
                    <span class="strategy-icon">‚ö°</span>
                    <div class="strategy-name">
                        <h3>SCALPER</h3>
                        <span>5 Minute Candles</span>
                    </div>
                </div>
                <div class="strategy-stats">
                    <div class="strategy-stat">
                        <div class="strategy-stat-label">Trades</div>
                        <div class="strategy-stat-value" id="scalperTrades">0</div>
                    </div>
                    <div class="strategy-stat">
                        <div class="strategy-stat-label">Win Rate</div>
                        <div class="strategy-stat-value" id="scalperWinRate">0%</div>
                    </div>
                    <div class="strategy-stat">
                        <div class="strategy-stat-label">P&L</div>
                        <div class="strategy-stat-value" id="scalperPnL">$0</div>
                    </div>
                </div>
                <div class="strategy-config"><strong>Config:</strong> 8% risk | 1.5x TP | 8 max pos</div>
            </div>
            <div class="strategy-card swing">
                <div class="strategy-header">
                    <span class="strategy-icon">üéØ</span>
                    <div class="strategy-name">
                        <h3>SWING</h3>
                        <span>4 Hour Candles</span>
                    </div>
                </div>
                <div class="strategy-stats">
                    <div class="strategy-stat">
                        <div class="strategy-stat-label">Trades</div>
                        <div class="strategy-stat-value" id="swingTrades">0</div>
                    </div>
                    <div class="strategy-stat">
                        <div class="strategy-stat-label">Win Rate</div>
                        <div class="strategy-stat-value" id="swingWinRate">0%</div>
                    </div>
                    <div class="strategy-stat">
                        <div class="strategy-stat-label">P&L</div>
                        <div class="strategy-stat-value" id="swingPnL">$0</div>
                    </div>
                </div>
                <div class="strategy-config"><strong>Config:</strong> 50% risk | Fib TP | Trend + Volume</div>
            </div>
        </div>

        <div class="section control-panel">
            <div class="section-title">üß≠ Bot Controls</div>
            <div class="control-grid">
                <div class="control-group">
                    <div class="control-label">Bot Actions</div>
                    <div class="control-row">
                        <button class="btn-action btn-primary" onclick="startBot()">‚ñ∂ Start Bot</button>
                        <button class="btn-action btn-warning" onclick="stopBot()">‚è∏ Stop Bot</button>
                        <button class="btn-action" onclick="restartBot()">üîÑ Restart Bot</button>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">Trading Mode</div>
                    <div class="control-row">
                        <select id="tradingModeSelect" class="select-control" onchange="setTradingMode(this.value)">
                            <option value="COMBINED" selected>üöÄ Combined (Scalp + Swing)</option>
                            <option value="SCALPING">‚ö° Scalper Only (5m)</option>
                            <option value="SWING">üéØ Swing Only (4h)</option>
                        </select>
                        <span class="control-note">Combined mode runs both strategies simultaneously.</span>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">Execution Mode</div>
                    <div class="control-row">
                        <select id="executionModeSelect" class="select-control" onchange="setExecutionMode(this.value)">
                            <option value="SIMULATED" selected>üìä Simulated Trading</option>
                            <option value="LIVE">üî¥ Live Trading</option>
                        </select>
                        <span class="control-note" style="color: #ffaa00;">‚ö†Ô∏è Live mode will execute real trades with your Kraken balance.</span>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">Emergency</div>
                    <div class="control-row">
                        <button class="btn-action btn-danger" onclick="cancelAllTrades()">‚õî Cancel All Trades</button>
                    </div>
                </div>
                <div class="control-status" id="controlStatus">Ready.</div>
            </div>
        </div>

        <div class="dashboard-wrapper">
            <!-- LEFT COLUMN -->
            <div class="left-column">
                <!-- Open Positions -->
                <div class="section">
                    <div class="section-title">üìà Open Positions</div>
                    <table id="openPositionsTable">
                        <thead>
                            <tr>
                                <th>Action</th>
                                <th>Symbol</th>
                                <th>Entry Price</th>
                                <th>Size ($)</th>
                                <th>Stop Loss</th>
                                <th>Target</th>
                                <th>Confidence</th>
                                <th>Indicators</th>
                            </tr>
                        </thead>
                        <tbody id="openPositionsBody">
                            <tr>
                                <td colspan="8" class="no-data">No open positions</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div class="right-column">
                <!-- Recent Closed Trades -->
                <div class="section">
                    <div class="section-title">‚úÖ Recent Closed Trades</div>
                    <table id="closedTradesTable">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Entry Price</th>
                                <th>Exit Price</th>
                                <th>P&L</th>
                                <th>Return %</th>
                                <th>Reason</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="closedTradesBody">
                            <tr>
                                <td colspan="7" class="no-data">No closed trades yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="refresh-info">
            üì° Dashboard updates every 2 seconds | Data refreshed at: <span id="refreshTime">--:--:--</span>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        const REFRESH_INTERVAL = 2000; // 2 seconds

        // Format currency
        function formatCurrency(num) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(num);
        }

        // Format percentage
        function formatPercent(num) {
            const sign = num >= 0 ? '+' : '';
            return `${sign}${num.toFixed(2)}%`;
        }

        // Format time
        function formatTime(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleTimeString();
        }

        // Close trade
        async function closeTrade(tradeId) {
            if (!confirm('Are you sure you want to close this trade?')) return;

            try {
                const response = await fetch(`${API_BASE}/close-trade`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tradeId })
                });

                const result = await response.json();
                if (result.success) {
                    // Immediately update dashboard to reflect the change
                    await updateDashboard();
                } else {
                    console.error('Error closing trade:', result.error);
                }
            } catch (err) {
                console.error('Error closing trade:', err);
            }
        }

        function setControlStatus(message, isError = false) {
            const statusEl = document.getElementById('controlStatus');
            statusEl.textContent = message;
            statusEl.className = isError ? 'control-status status-error' : 'control-status status-ok';
        }

        async function sendBotCommand(endpoint, payload = null) {
            try {
                setControlStatus('Sending command...');
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: payload ? JSON.stringify(payload) : null
                });

                const result = await response.json();
                if (response.ok) {
                    // Show immediate feedback based on command
                    const commandType = endpoint.split('/').pop();
                    let statusMessage = result.message || 'Command queued.';
                    
                    if (commandType === 'start') {
                        setControlStatus('‚úÖ Bot is running');
                    } else if (commandType === 'stop') {
                        setControlStatus('‚è∏Ô∏è Bot stopped');
                    } else if (commandType === 'restart') {
                        setControlStatus('üîÑ Bot restarting...');
                        setTimeout(() => setControlStatus('‚úÖ Bot is running'), 2000);
                    } else {
                        setControlStatus(statusMessage);
                    }
                } else {
                    setControlStatus(result.error || 'Command failed.', true);
                }
            } catch (err) {
                setControlStatus('Command error. Check console.', true);
                console.error('Command error:', err);
            }
        }

        let refreshInterval = null;

        function startBot() {
            // Start polling when bot starts
            if (!refreshInterval) {
                updateDashboard();
                refreshInterval = setInterval(updateDashboard, REFRESH_INTERVAL);
                console.log('Dashboard polling started');
            }
            return sendBotCommand('/bot/start');
        }

        function stopBot() {
            // Stop polling when bot stops
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
                console.log('Dashboard polling stopped');
            }
            return sendBotCommand('/bot/stop');
        }

        function restartBot() {
            return sendBotCommand('/bot/restart');
        }

        function cancelAllTrades() {
            if (!confirm('üö® Cancel all open trades and orders on Kraken?')) return;
            sendBotCommand('/bot/cancel-all-trades', {})
                .then(response => {
                    if (response.success) {
                        document.getElementById('controlStatus').textContent = '‚úÖ ' + response.message;
                        setTimeout(() => {
                            document.getElementById('controlStatus').textContent = 'Ready.';
                        }, 5000);
                    }
                });
        }

        function setTradingMode(mode) {
            return sendBotCommand('/bot/mode', { mode });
        }

        function setExecutionMode(mode) {
            if (mode === 'LIVE') {
                startCoinBalancePolling();
            } else {
                stopCoinBalancePolling();
            }
            return sendBotCommand('/bot/execution', { mode });
        }

        // Update dashboard
        async function updateDashboard() {
            try {
                const response = await fetch(`${API_BASE}/data`);
                const data = await response.json();

                console.log('Dashboard data received:', data);

                // Update stats
                const stats = data.stats;
                document.getElementById('currentBalance').textContent = formatCurrency(stats.currentBalance);
                document.getElementById('availableBalance').textContent = formatCurrency(stats.availableBalance);
                document.getElementById('investedCapital').textContent = formatCurrency(stats.currentBalance - stats.availableBalance);
                document.getElementById('totalReturn').textContent = formatPercent(stats.totalReturn);
                document.getElementById('totalProfitLoss').textContent = formatCurrency(stats.totalProfitLoss);
                document.getElementById('winRate').textContent = stats.winRate + '%';
                document.getElementById('totalTrades').textContent = stats.totalTrades;
                document.getElementById('totalWins').textContent = stats.totalWins;
                document.getElementById('totalLosses').textContent = stats.totalLosses;
                document.getElementById('openPositions').textContent = stats.openPositions;
                document.getElementById('lastUpdate').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
                document.getElementById('refreshTime').textContent = new Date().toLocaleTimeString();

                console.log('Trades array:', data.trades);
                console.log('Open trades count:', data.trades.filter(t => t.status === 'OPEN').length);

                // Update color based on P&L
                const plElement = document.getElementById('totalProfitLoss');
                plElement.className = stats.totalProfitLoss >= 0 ? 'positive' : 'negative';
                const returnElement = document.getElementById('totalReturn');
                returnElement.className = stats.totalReturn >= 0 ? 'positive' : 'negative';

                // Update open positions
                updateOpenPositions(data.trades);

                // Update closed trades
                updateClosedTrades(data.trades);

                // Update strategy cards
                updateStrategyCards(data.trades, stats);

            } catch (err) {
                console.error('Error updating dashboard:', err);
            }
        }

        // Update strategy performance cards
        function updateStrategyCards(trades, stats) {
            const closedTrades = trades.filter(t => t.status === 'CLOSED');
            const totalTrades = closedTrades.length;
            const wins = closedTrades.filter(t => t.profitLoss > 0).length;
            const totalPnL = closedTrades.reduce((sum, t) => sum + (t.profitLoss || 0), 0);
            const winRate = totalTrades > 0 ? ((wins / totalTrades) * 100).toFixed(1) : 0;

            // For combined mode, split stats evenly between both strategies as placeholder
            // In future: filter by trade.strategy === 'SCALPING' or 'SWING'
            const halfTrades = Math.floor(totalTrades / 2);
            const halfPnL = totalPnL / 2;

            // Update Scalper card
            document.getElementById('scalperTrades').textContent = halfTrades;
            document.getElementById('scalperWinRate').textContent = winRate + '%';
            const scalperPnLEl = document.getElementById('scalperPnL');
            scalperPnLEl.textContent = formatCurrency(halfPnL);
            scalperPnLEl.className = halfPnL >= 0 ? 'strategy-stat-value positive' : 'strategy-stat-value negative';

            // Update Swing card
            document.getElementById('swingTrades').textContent = totalTrades - halfTrades;
            document.getElementById('swingWinRate').textContent = winRate + '%';
            const swingPnLEl = document.getElementById('swingPnL');
            swingPnLEl.textContent = formatCurrency(totalPnL - halfPnL);
            swingPnLEl.className = (totalPnL - halfPnL) >= 0 ? 'strategy-stat-value positive' : 'strategy-stat-value negative';
        }

        function updateOpenPositions(trades) {
            const openTrades = trades.filter(t => t.status === 'OPEN');
            const tbody = document.getElementById('openPositionsBody');

            if (openTrades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">No open positions</td></tr>';
                return;
            }

            tbody.innerHTML = openTrades.map(trade => {
                const indicators = [trade.pattern, trade.indicators].filter(Boolean).join(', ');
                // Calculate position size in USD (Size * Entry Price)
                const entryPrice = trade.entryPrice || 0;
                const stopPrice = trade.stopPrice || 0;
                const targetPrice = trade.targetPrice || 0;
                const sizeInUsd = trade.positionSize ? formatCurrency(trade.positionSize * entryPrice) : 'N/A';

                return `
                    <tr>
                        <td>
                            <button class="btn-close" onclick="closeTrade('${trade.id}')">‚úñ Close</button>
                        </td>
                        <td>${trade.symbol}</td>
                        <td>$${entryPrice.toFixed(2)}</td>
                        <td>${sizeInUsd}</td>
                        <td>$${stopPrice.toFixed(2)}</td>
                        <td>$${targetPrice.toFixed(2)}</td>
                        <td>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${trade.confidence || 0}%">
                                    ${trade.confidence || 0}%
                                </div>
                            </div>
                        </td>
                        <td><span class="indicator">${indicators || 'N/A'}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function updateClosedTrades(trades) {
            const closedTrades = trades
                .filter(t => t.status === 'CLOSED')
                .sort((a, b) => new Date(b.exitTime) - new Date(a.exitTime))
                .slice(0, 15);

            const tbody = document.getElementById('closedTradesBody');

            if (closedTrades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">No closed trades yet</td></tr>';
                return;
            }

            tbody.innerHTML = closedTrades.map(trade => {
                const profitClass = trade.profitLoss >= 0 ? 'positive' : 'negative';
                return `
                    <tr>
                        <td>${trade.symbol}</td>
                        <td>$${trade.entryPrice.toFixed(2)}</td>
                        <td>$${trade.exitPrice.toFixed(2)}</td>
                        <td class="${profitClass}">$${trade.profitLoss.toFixed(2)}</td>
                        <td class="${profitClass}">${formatPercent(trade.profitLossPercent)}</td>
                        <td>${trade.reason}</td>
                        <td>${formatTime(trade.exitTime)}</td>
                    </tr>
                `;
            }).join('');
        }

        // Dashboard polling starts when bot is started
        // No auto-refresh on page load - user must click Start Bot

        // Coin Holdings
        async function fetchCoinBalances() {
            try {
                const response = await fetch(`${API_BASE}/coin-balances`);
                const data = await response.json();
                if (!data.success) return;

                const grid = document.getElementById('coinHoldingsGrid');
                const totalEl = document.getElementById('holdingsTotalValue');
                totalEl.textContent = `Total: ${formatCurrency(data.totalValueUsd)}`;

                if (!data.holdings || data.holdings.length === 0) {
                    grid.innerHTML = '<div class="no-data">No coin balances found</div>';
                    return;
                }

                grid.innerHTML = data.holdings.map(h => {
                    const trendClass = !h.trend ? '' : h.trend.signal === 'BULLISH' ? 'trend-bull' : h.trend.signal === 'BEARISH' ? 'trend-bear' : '';
                    const trendLabel = !h.trend ? '--' : `${h.trend.signal} ${h.trend.confidence}%`;
                    const showSell = h.coin !== 'USD' && h.free > 0;
                    return `
                        <div class="coin-card">
                            <div class="coin-name">${h.coin}</div>
                            <div class="coin-amount">${h.coin === 'USD' ? '' : h.total.toFixed(6)}</div>
                            <div class="coin-value">${formatCurrency(h.valueUsd)}</div>
                            <div class="coin-price">${h.coin === 'USD' ? '' : '@ $' + h.price.toFixed(h.price < 1 ? 6 : 2)}</div>
                            <div class="coin-trend ${trendClass}">${trendLabel}</div>
                            ${showSell ? `<button class="btn-sell" onclick="sellCoin('${h.symbol}', '${h.coin}')">Sell All</button>` : ''}
                        </div>
                    `;
                }).join('');
            } catch (err) {
                console.error('Error fetching coin balances:', err);
            }
        }

        async function sellCoin(symbol, coin) {
            if (!confirm(`Sell ALL ${coin} at market price?`)) return;
            try {
                setControlStatus(`Selling ${coin}...`);
                const response = await fetch(`${API_BASE}/sell-coin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol })
                });
                const result = await response.json();
                if (result.success) {
                    setControlStatus(`‚úÖ Sold ${coin} @ $${result.order.average?.toFixed(2) || 'pending'}`);
                    fetchCoinBalances();
                } else {
                    setControlStatus(`‚ùå ${result.error}`, true);
                }
            } catch (err) {
                setControlStatus('Sell failed. Check console.', true);
                console.error('Sell error:', err);
            }
        }

        // Coin balance polling (only when live mode active)
        let coinBalanceInterval = null;
        function startCoinBalancePolling() {
            const section = document.getElementById('coinHoldingsSection');
            section.style.display = '';
            fetchCoinBalances();
            if (!coinBalanceInterval) {
                coinBalanceInterval = setInterval(fetchCoinBalances, 30000);
            }
        }
        function stopCoinBalancePolling() {
            const section = document.getElementById('coinHoldingsSection');
            section.style.display = 'none';
            if (coinBalanceInterval) {
                clearInterval(coinBalanceInterval);
                coinBalanceInterval = null;
            }
        }
    </script>
</body>

</html>